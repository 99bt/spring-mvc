package com.yaowang.lansha.service.impl;import java.util.ArrayList;import java.util.Date;import java.util.HashSet;import java.util.List;import java.util.Map;import java.util.Set;import javax.annotation.Resource;import org.apache.commons.lang.StringUtils;import org.springframework.stereotype.Service;import org.springframework.util.CollectionUtils;import com.yaowang.common.constant.BaseConstant;import com.yaowang.common.dao.PageDto;import com.yaowang.entity.AdminUser;import com.yaowang.lansha.common.constant.LanshaConstant;import com.yaowang.lansha.dao.YwUserRoomApplyDao;import com.yaowang.lansha.entity.YwUser;import com.yaowang.lansha.entity.YwUserRoom;import com.yaowang.lansha.entity.YwUserRoomApply;import com.yaowang.lansha.service.YwUserRoomApplyService;import com.yaowang.lansha.service.YwUserRoomService;import com.yaowang.lansha.service.YwUserService;import com.yaowang.service.AdminUserService;import com.yaowang.util.UUIDUtils;/** * 热门推荐房间  * @author  *  */@Service("ywUserRoomApplyService")public class YwUserRoomApplyServiceImpl implements YwUserRoomApplyService{	@Resource	private YwUserRoomApplyDao ywUserRoomApplyDao;		@Resource	private YwUserRoomService ywUserRoomService;		@Resource	private AdminUserService adminUserService;		@Resource	private YwUserService ywUserService;		@Override	public YwUserRoomApply save(YwUserRoomApply entity){		return ywUserRoomApplyDao.save(entity);	}		@Override	public Integer delete(String[] ids){		return ywUserRoomApplyDao.delete(ids);	}		@Override	public Integer update(YwUserRoomApply entity){		return ywUserRoomApplyDao.update(entity);	}		@Override	public YwUserRoomApply getYwUserRoomApplyById(String id){		return ywUserRoomApplyDao.getYwUserRoomApplyById(id);	}		@Override	public Map<String, YwUserRoomApply> getYwUserRoomApplyMapByIds(String[] ids){		return ywUserRoomApplyDao.getYwUserRoomApplyMapByIds(ids);	}		@Override	public List<YwUserRoomApply> getYwUserRoomApplyList(YwUserRoomApply entity){		return ywUserRoomApplyDao.getYwUserRoomApplyList(entity);	}		@Override	public List<YwUserRoomApply> getYwUserRoomApplyPage(YwUserRoomApply entity, Date startTime, Date endTime, PageDto page){		if(entity != null && entity.getUserIdInt() != null && entity.getUserIdInt() != 0){			YwUser user = ywUserService.getYwUserByIdInt(entity.getUserIdInt());			if(user == null){				return new ArrayList<YwUserRoomApply>();			}else{				entity.setUserId(user.getId());			}		}				return ywUserRoomApplyDao.getYwUserRoomApplyPage(entity, startTime, endTime, page);	}	@Override	public void setName(List<YwUserRoomApply> list) {		if(CollectionUtils.isEmpty(list)){			return;		}		Set<String> ods = new HashSet<String>();		Set<String> ids = new HashSet<String>();		for(YwUserRoomApply y : list){			ods.add(y.getAduitUid());			ids.add(y.getUserId());		}		Map<String, AdminUser> map = adminUserService.getAdminUserMapByIds(ods.toArray(new String[]{}));		Map<String, YwUser> m = ywUserService.getYwUserMapByIds(ids.toArray(new String[]{}));		for(YwUserRoomApply y : list){			if(m.containsKey(y.getUserId())){				y.setUsername(m.get(y.getUserId()).getUsername());				y.setUserIdInt(m.get(y.getUserId()).getIdInt());			}			if(map.containsKey(y.getAduitUid())){				y.setAduitName(map.get(y.getAduitUid()).getUsername());			}		}	}	@Override	public Integer updateForApply(YwUserRoomApply entity) {		return ywUserRoomApplyDao.updateApply(entity);	}	@Override	public Integer updateForAudit(YwUserRoomApply entity, YwUser user) {		if(user == null){			return 0;		}		if(LanshaConstant.MASTER_STATUS_VETTED.equals(entity.getStatus())){			//将用户设置为主播			user.setUserType(LanshaConstant.USER_TYPE_ANCHOR);			user.setAuthe(BaseConstant.YES);			if(StringUtils.isBlank(user.getAccountType())){				user.setAccountType(null);			}			ywUserService.update(user);			//创建房间			YwUserRoom ywUserRoom = new YwUserRoom();			ywUserRoom.setId(UUIDUtils.newId());			ywUserRoom.setUid(entity.getUserId());			ywUserRoom.setName(StringUtils.isBlank(entity.getRoomName()) ? user.getNickname()+"的房间" : entity.getRoomName());			ywUserRoom.setOnline(LanshaConstant.ROOM_STATUS_OFFLINE);			ywUserRoom.setGameId(entity.getGameId());			ywUserRoom.setNotice(entity.getNotice());			ywUserRoom.setRtmp("");			ywUserRoom.setRoomId("");			ywUserRoom.setFans(0);			ywUserRoom.setNumber(0);			ywUserRoom.setOrderId(0);			ywUserRoom.setReportNum(0);			ywUserRoom.setTimeLength(0);			ywUserRoom.setBaseNumber(0);			ywUserRoom.setMultipleNumber(1);			ywUserRoom.setCreateTime(new Date());			ywUserRoom.setSign("0");			ywUserRoomService.save(ywUserRoom);		}		return update(entity);	}	}